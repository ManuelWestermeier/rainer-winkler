<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Canvas Image Storm â€“ CORS SAFE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: black;
}
canvas {
  display: block;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
"use strict";

/* ======================
   GLOBAL ERROR LOGGING
   ====================== */
window.onerror = (m,s,l,c,e)=>console.error("WINDOW ERROR",m,s,l,c,e);
window.onunhandledrejection = e=>console.error("PROMISE ERROR",e.reason);

/* ======================
   CANVAS
   ====================== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

console.log("Canvas OK", canvas.width, canvas.height);

/* ======================
   IMAGE LOADING (CORS)
   ====================== */
const PROXY = "https://corsproxy.io/?";
const RAW_IMAGES = [
  "https://media0.faz.net/image/w1240/2e9380d6be6a/w1920h864x0y168/202212/1.8543712/rainer-winkler-alias.webp",
  "https://www.watson.ch/imgdb/1ac5/Qx,A,0,0,768,432,320,180,128,72/3037309909412135",
  "https://i.etsystatic.com/54136756/r/il/e05fa7/7019977722/il_1588xN.7019977722_a2es.jpg",
  "https://www.merkur.de/assets/images/27/311/27311552-rainer-winkler-drachenlord-youtube-screenshot-hate-speech-2H6T5427XkMH.jpg"
];

const images = [];
let readyImages = 0;

RAW_IMAGES.forEach((url, i) => {
  const img = new Image();
  img.onload = () => {
    readyImages++;
    console.log("IMAGE OK", i, img.width, img.height);
  };
  img.onerror = e => console.error("IMAGE FAIL", i, url, e);
  img.src = PROXY + encodeURIComponent(url);
  images.push(img);
});

/* ======================
   RANDOM
   ====================== */
const R = (a,b)=>Math.random()*(b-a)+a;
const RI = (a,b)=>(Math.random()*(b-a+1)|0)+a;

/* ======================
   PARTICLES
   ====================== */
const MAX = 2500;
const ADD = 30;
const parts = [];

class Particle {
  reset() {
    this.x = R(0, canvas.width);
    this.y = R(0, canvas.height);
    this.vx = R(-1.5,1.5);
    this.vy = R(-1.5,1.5);
    this.r = R(0,Math.PI*2);
    this.rs = R(-0.05,0.05);
    this.s = R(30,160);
    this.life = RI(300,1200);
    this.max = this.life;
    this.fx = RI(0,3);
    this.img = images[RI(0, images.length-1)];
  }

  constructor(){ this.reset(); }

  update(){
    this.x+=this.vx;
    this.y+=this.vy;
    this.r+=this.rs;
    if(--this.life<=0) this.reset();
  }

  draw(){
    if(!this.img.complete) return;

    const t=this.life/this.max;
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.r);

    if(this.fx===0) ctx.globalAlpha=t;
    if(this.fx===1) ctx.scale(1+Math.sin(t*6)*0.3,1);
    if(this.fx===2) ctx.globalCompositeOperation="lighter";
    if(this.fx===3) ctx.scale(1,t+0.2);

    ctx.drawImage(this.img,-this.s/2,-this.s/2,this.s,this.s);
    ctx.restore();
    ctx.globalAlpha=1;
    ctx.globalCompositeOperation="source-over";
  }
}

/* ======================
   LOOP
   ====================== */
function loop(){
  try {
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    for(let i=0;i<ADD && parts.length<MAX;i++)
      parts.push(new Particle());

    for(const p of parts){
      p.update();
      p.draw();
    }
  } catch(e) {
    console.error("RENDER ERROR",e);
  }
  requestAnimationFrame(loop);
}

/* ======================
   START
   ====================== */
const wait = setInterval(()=>{
  console.log("IMAGE STATUS", readyImages, "/", images.length);
  if(readyImages>0){
    clearInterval(wait);
    console.log("STARTING LOOP");
    loop();
  }
},200);

</script>
</body>
</html>
